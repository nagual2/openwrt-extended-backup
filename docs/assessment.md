# OpenWrt Extended Backup — assessment

_Date: 2024-10-24_

## Executive summary
- Проект предоставляет два основных скрипта (`openwrt_full_backup` и `user_installed_packages`), однако оба зависят от ручных действий пользователя, не обрабатывают большинство ошибок и оставляют за собой небезопасное окружение.
- При включённом ksmbd скрипт создаёт сетевую шару с жёстко заданными учётными данными и не выполняет обратную очистку; при отключённом ksmbd архив остаётся только в `/tmp/archive/`, fallback не предложен.
- Скрипт `user_installed_packages` фактически ничего не выводит из-за ошибки в AWK и не пригоден для восстановления списка пакетов.
- Поддержка целевых релизов OpenWrt (22.03 / 23.05 / SNAPSHOT) требует доработок: имена пакетов ksmbd менялись, зависимость `ksmbd.adduser` не задекларирована, используются опции `tar`, отсутствующие в BusyBox-версии.
- UX и надёжность требуют пересмотра: отсутствуют CLI-флаги (`-h`, `-q`, `-v`), нет детерминированного поведения при повторном запуске, не предусмотрена интеграция с shellcheck/shfmt и автотестами.

## Script audit

### `openwrt_full_backup`
**Плюсы:** обнаружение версии, автоматическая установка `tar`, базовая интеграция с ksmbd.

**Найденные проблемы:**
- **Совместимость и POSIX:** предполагается наличие `br-lan`; на устройствах с иным интерфейсом IP не определяется. Используются GNU-ключи `tar --same-owner/--preserve-permissions`, которые отсутствуют у BusyBox tar (стандарт для 22.03), что приведёт к ошибкам.
- **Обработка ошибок:** отсутствует `set -eu`, команды `opkg` и `ksmbd.adduser` не проверяются, ошибки `tar` подавляются (`2>/dev/null`), что маскирует сбои.
- **Очистка и trap:** временный скрипт добавляется в `/etc/rc.local`, но share/пользователь ksmbd не удаляются; при прерывании процесса остаточные записи в UCI и rc.local остаются навсегда.
- **Безопасность SMB:** создаётся пользователь `RR`/`12345`, включается `guest_ok yes`, директория архивов принудительно `0777`. Счётные данные не регенерируются, конфигурация не откатывается.
- **Ветвления ksmbd:** переменная `ksmbd_otkaz` остаётся `0`, если установка ksmbd не удалась, и скрипт всё равно пытается применять `uci`, что приведёт к ошибкам и нечистому состоянию. При отказе ksmbd fallback ограничивается сообщением «архив в /tmp/archive».
- **UX:** используется `clear`/`sleep`, что мешает запуску в CI/через cron; отсутствует подсказка `-h` и режим тихого логирования.

### `user_installed_packages`
**Плюсы:** выбирается версия, парсится `/usr/lib/opkg/status` блоками, соблюдается quoting.

**Найденные проблемы:**
- **Функциональный дефект:** в AWK используется переменная `pkg_name`, которая никогда не присваивается (используется `pkg`), поэтому скрипт не выводит ни одной команды `opkg install`.
- **Лишняя логика:** переменная `DISTRI_TIME` вычисляется, но не применяется.
- **Надёжность:** отсутствует проверка наличия `/usr/lib/opkg/status`, нет `set -eu`, скрипт очищает экран командой `clear`.
- **UX:** нет помощи (`-h`), нельзя фильтровать пакеты, вывод нельзя перенаправить в файл без удаления декоративных линий.

## Dependencies & compatibility
- **Неявные зависимости:** `ksmbd.adduser` (из `ksmbd-tools)` и `uci` не упомянуты в README/Makefile, хотя без них скрипт не работает. Текущая проверка `opkg list-installed | grep '^ksmbd-server'` не срабатывает на сборках, где пакет называется `ksmbd-tools` (OpenWrt ≥23.05) или когда установлен альтернативный SMB-сервер.
- **BusyBox tar:** в стандартных образах 22.03/23.05 установлен BusyBox tar без GNU-опций, поэтому архивирование завершается ошибкой. Скрипт пытается установить «полную» версию tar, но не проверяет результат и не учитывает недостаток flash.
- **Архитектуры (mips/arm/x86):** ценность сценария не зависит от архитектуры, однако `ip -4 addr show br-lan` не работает на x86 за NAT или mips/arm bridge-less устройствах. Не хватает проверок наличия необходимых утилит.
- **SNAPSHOT:** пакеты ksmbd могут быть отключены или переименованы, `opkg update` из скрипта может быть запрещён в оффлайн-окружении.

## UX & reliability
- Нет описания флагов (`-h`, `--help`), режимов тихого/подробного логирования и согласованного формата вывода.
- Скрипты интерактивны (prompt + `sleep`), что делает автоматизацию невозможной.
- Нет идемпотентности: повторный запуск пересоздаёт пользователь/шару, дублируя UCI-записи.
- Архивы складываются в `/tmp/archive` без ротации и проверки свободного места.

## SMB fallback recommendations
- На основе анализа кода проверены оба пути: при установленном ksmbd (создание share) и при отказе (сообщение об архиве в `/tmp`). В обоих случаях отсутствует автоматизированный метод выгрузки данных.
- Рекомендуемый fallback: автоматическое предложение команд `scp`/`sftp` (через `dropbear`) с краткой инструкцией; альтернативно — временный HTTP endpoint c использованием `uhttpd` в режиме `readonly`, с обязательным `trap` для остановки.
- При наличии ksmbd следует делать его опциональным (`--export=smb|scp|http|none`) и очищать UCI-конфигурацию после завершения.

## Quality & maintainability
- В репозитории есть GitHub Actions для shfmt/shellcheck, но сами скрипты написаны до их включения и не соответствуют рекомендациям (`set -eu`, `trap cleanup` и т. п.).
- Отсутствует тестовое покрытие (например, BATS или shunit2) и статическая проверка POSIX несовместимых конструкций.
- Нет документации по поддерживаемым комбинациям версий OpenWrt и зависимостям.

## Packaging & automation
- Существует `openwrt/Makefile` (feed), но отсутствует разделение на package/Config.in и инструкция по включению в кастомный feed.
- Поле `PKG_LICENSE` установлено как `Proprietary`, что затрудняет публикацию; фактическая лицензия не указана.
- В ipk-артефакте отсутствуют man/README, нет postinst/prerm скриптов для очистки ksmbd-конфигурации.

## Prioritized roadmap
| Priority | Улучшение | Обоснование | Оценка |
| --- | --- | --- | --- |
| P0 | Переписать `openwrt_full_backup` с жёсткой обработкой ошибок, `set -euo pipefail`, `trap cleanup`, проверкой зависимостей | Базовая безопасность и надёжность бэкапа | L |
| P0 | Исправить `user_installed_packages`, добавить неинтерактивный вывод и авто-тест | Скрипт не выполняет свою функцию | S |
| P1 | Ввести безопасную модель экспорта (варианты smb/scp/http) + очистка UCI после завершения | Закрывает сценарии с отключённым ksmbd и повышает безопасность | M |
| P1 | Добавить CLI-интерфейс с флагами `--help`, `--quiet`, `--verbose`, `--non-interactive` | Улучшает UX/автоматизацию | M |
| P2 | Документировать и проверить поведение на OpenWrt 22.03/23.05/SNAPSHOT (arm/mips/x86), скорректировать зависимости | Снимает риски несовместимости | M |
| P2 | Расширить CI: добавить линтер на POSIX совместимость, smoke-тесты (BATS), проверку packaging | Поддержка качества | L |
| P3 | Подготовить документацию (README, man page) и пример feed overlay | Упрощает распространение | S |

## Быстрые победы (quick wins)
- Исправить ошибку `pkg_name` → `pkg` в `user_installed_packages` и добавить простую проверку в CI.
- Добавить явную проверку наличия `ksmbd.adduser` и `uci`, завершать скрипт с ошибкой при отсутствии.
- Заменить `clear`/`sleep` на структурированное логирование.
- Убрать жёстко заданные креды SMB, генерировать случайные пароли и выводить их пользователю.

## Draft follow-up tasks
1. **[S] user_installed_packages: починить AWK и добавить smoke-тест**  
   - Исправить переменные (`pkg_name` → `pkg`).  
   - Написать тест (BATS) на вывод хотя бы одного пакета при подготовленных данных.  
   - Acceptance: CI тест падает без фикса, проходит после.
2. **[M] openwrt_full_backup: ввести `set -euo pipefail`, `trap cleanup` и централизованную обработку ошибок**  
   - Обернуть критические вызовы (`opkg`, `tar`, `uci`) в функции с логированием.  
   - Реализовать trap для удаления временных файлов, UCI-записей и пользователя ksmbd.  
   - Acceptance: ручной сценарий прерывания (Ctrl+C) не оставляет следов.
3. **[M] Экспорт без ksmbd: реализовать `--export=scp|http|none`**  
   - Если ksmbd отсутствует, автоматически выводить команду `scp`/`sftp` с подсказкой.  
   - Добавить опцию временного HTTP (`uhttpd`) с basic auth.  
   - Acceptance: тестовые сценарии показывают корректные инструкции при отключённом ksmbd.
4. **[M] CLI-политика и логирование**  
   - Добавить `--help`, `--quiet`, `--verbose`, `--non-interactive`.  
   - Реализовать единый логгер (info/warn/error).  
   - Acceptance: Shellcheck и shfmt проходят, вывод соответствует выбранному уровню.
5. **[S] Проверка зависимостей и совместимости**  
   - Реализовать функцию `require_cmd` с понятными ошибками.  
   - Документировать минимальные версии пакетов и отличия OpenWrt 22.03/23.05/SNAPSHOT.  
   - Acceptance: README содержит таблицу совместимости, скрипты завершаются при отсутствии зависимостей.
6. **[L] Безопасное управление SMB**  
   - Генерировать одноразового пользователя/пароль, ограничивать доступ только к архиву.  
   - Автоматически отключать шару и удалять пользователя в `trap`.  
   - Acceptance: после завершения ksmbd-config сравнима с исходной.
7. **[L] Тесты и эмуляция архитектур**  
   - Подготовить QEMU/BATS pipeline для mips/arm/x86 с матрицей релизов (22.03, 23.05).  
   - Запускать smoke-тесты архивации и fallback'ов.  
   - Acceptance: CI успешно прогоняет хотя бы smoke-тесты на двух архитектурах.
8. **[S] Документация и лицензия**  
   - Уточнить лицензию, обновить README.  
   - Добавить раздел «Безопасность» и инструкцию по установке `ipk`/feed.  
   - Acceptance: документация включает таблицу флагов CLI и описание fallback.
