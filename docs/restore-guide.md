# Руководство по восстановлению из резервной копии

Это руководство дополняет README и описывает процесс восстановления конфигурации OpenWrt из архива, созданного скриптом `openwrt_full_backup`. Для автоматизированного восстановления используйте скрипт `openwrt_full_restore` (см. раздел 3). Следуйте шагам по порядку, чтобы избежать потери данных и обеспечить корректную работу системы.

## 1. Подготовка
1. **Используйте тот же релиз OpenWrt.** Резервная копия предназначена для восстановления на прошивку той же версии (например, 22.03.5 → 22.03.5). При попытке восстановления на другую ветку возможны несовместимости.
2. **Сделайте аппаратный или программный сброс.** Перед восстановлением сбросьте устройство к заводскому состоянию (`Reset` кнопкой, `firstboot`, `jffs2reset -y`). Это исключит конфликт старых настроек с новыми файлами.
3. **Скопируйте архив локально.** Убедитесь, что файл `fullbackup_<верссия>_<дата>.tar.gz` сохранён на компьютере или в другом надёжном хранилище.
4. **Подготовьте данные для переустановки пакетов.** Если вы создали список через `user_installed_packages`, держите его под рукой — он пригодится после восстановления.

## 2. Проверка целостности архива
Перед загрузкой на роутер убедитесь, что архив не повреждён:
```sh
tar -tzf fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz > /dev/null
```
Ошибки распаковки означают, что файл повреждён — восстановление продолжать нельзя.

## 3. Восстановление через `openwrt_full_restore`
1. Подключитесь к роутеру по SSH и скопируйте архив в `/tmp` (см. разделы выше).
2. Выполните проверку в режиме dry-run:
   ```sh
   openwrt_full_restore --dry-run --archive /tmp/fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz
   ```
   Скрипт проверит архив, покажет количество новых и перезаписываемых файлов, а также список служб для перезапуска.
3. Если отчёт вас устраивает, примените восстановление:
   ```sh
   openwrt_full_restore --archive /tmp/fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz
   ```
   Дополнительно можно указать `--yes` для автоматического подтверждения и `--packages /tmp/opkg-user-packages.sh`, чтобы переустановить пакеты.
4. По завершении изучите итоговый отчёт: он содержит путь к резервным копиям перезаписанных файлов (`/tmp/openwrt-restore-backup-*`), сведения о перезапущенных службах и статус скрипта пакетов. После проверки удалите временные резервные копии, если они больше не нужны.

## 4. Восстановление через веб-интерфейс LuCI
1. Загрузитесь на «чистом» устройстве и откройте LuCI (`http://192.168.1.1`).
2. Перейдите в **Система → Резервное копирование / Обновление**.
3. В блоке «Восстановить» нажмите **Выберите файл**, укажите сохранённый архив и подтвердите загрузку.
4. После загрузки нажмите **Восстановить резервную копию**. LuCI распакует архив в `/overlay` и перезагрузит устройство.
5. Дождитесь полной перезагрузки и проверьте доступность устройства по прежним адресам/учётным данным.

## 5. Восстановление через SSH/консоль
Используйте этот метод, если веб-интерфейс недоступен.

1. Подключитесь к роутеру по SSH (по умолчанию `root@192.168.1.1`).
2. Скопируйте архив в `/tmp`:
   ```sh
   scp fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz root@192.168.1.1:/tmp/
   ```
3. На роутере убедитесь, что места достаточно: `df -h /tmp`.
4. Проверьте архив на устройстве: `tar -tzf /tmp/fullbackup_*.tar.gz > /dev/null`.
5. Распакуйте поверх текущей файловой системы:
   ```sh
   tar -xzp -f /tmp/fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz -C /
   sync
   ```
6. Перезапишите свободное место и перезагрузите устройство:
   ```sh
   rm -f /tmp/fullbackup_*.tar.gz
   reboot
   ```

> Примечание: команда `tar -xzp` корректно обработает сохранённые права и владельцев. Если в архиве присутствует `etc/rc.local`, он заменит текущий файл.

## 6. После восстановления
1. **Проверьте основные сервисы.** Убедитесь, что сеть, Wi-Fi, VPN и другие службы стартовали согласно прежней конфигурации.
2. **Переустановите дополнительные пакеты.** Выполните сохранённый скрипт:
   ```sh
   sh /tmp/opkg-user-packages.sh
   ```
   или повторите команды вручную.
3. **Удалите временные пользователи и шары.** Если вы включали `ksmbd`, убедитесь, что пользователь `RR` удалён и служба остановлена.
4. **Очистите временные файлы.** Удалите архив из `/tmp` и убедитесь, что нет лишних файлов в `/etc/rc.local`, созданных при резервном копировании.

## 7. Устранение неполадок
| Симптом | Возможная причина | Решение |
| --- | --- | --- |
| Устройство уходит в цикл перезагрузки | Несовместимая версия прошивки | Прошейте нужную версию OpenWrt и повторите восстановление. |
| После восстановления нет доступа по SSH | Сменились IP или ключи | Проверьте `network`/`wireless` в архиве, подключитесь через консоль, восстановите настройки вручную. |
| Сервисы не стартуют | Требуются дополнительные пакеты | Установите их заново через `opkg`, используя список из `user_installed_packages`. |
| Нет свободного места для распаковки | Недостаточно RAM в `/tmp` | Временно отключите лишние сервисы, используйте внешний накопитель, либо восстановите через LuCI (он подмонтирует архив напрямую). |

## 8. Рекомендации по безопасности
- Храните резервные копии в зашифрованном хранилище (например, парольный менеджер, VeraCrypt, шифрованный архив).
- После восстановления обновите все пароли, особенно если резервная копия долго лежала без использования.
- Не забывайте удалять временных пользователей SMB (`ksmbd.deluser RR`) и отключать саму службу (`/etc/init.d/ksmbd stop`).
- При передаче архива по сети используйте защищённые протоколы (SCP, SFTP, rsync через SSH).

Следуя этим шагам, вы сможете безопасно восстановить конфигурацию OpenWrt и вернуть работу маршрутизатора к привычному состоянию.
