# openwrt_full_backup & openwrt_full_restore
[![CI](https://github.com/nagual2/openwrt-extended-backup/actions/workflows/ci.yml/badge.svg)](https://github.com/nagual2/openwrt-extended-backup/actions/workflows/ci.yml)

Набор shell-утилит, выполняющихся напрямую на маршрутизаторе под управлением OpenWrt. Основной сценарий `openwrt_full_backup` создаёт полную резервную копию пользовательского слоя (`/overlay`), умеет на лету устанавливать недостающие зависимости и организует временный SMB-доступ к архиву. Комплементарная утилита `openwrt_full_restore` валидирует архив, безопасно восстанавливает файлы с предварительным резервным копированием текущего состояния, поддерживает dry-run и переустановку пакетов. Вспомогательный скрипт `user_installed_packages` выводит список вручную установленных пакетов для последующей переустановки.

> ⚠️ Архив сохраняется в оперативной памяти (`/tmp/archive`). После перезагрузки маршрутизатора файл исчезает — скачайте и сохраните его сразу после создания.

## Назначение
- Создание автономной резервной копии конфигурации и пользовательских данных OpenWrt.
- Безопасное восстановление архива на идентичную прошивку с проверкой и резервированием текущих файлов.
- Получение списка вручную установленных `opkg`-пакетов для повторной установки.

## Основные возможности
- `openwrt_full_backup`
  - Архивирует весь пользовательский слой (`/overlay`) с сохранением прав и владельцев.
  - Проверяет наличие необходимых пакетов (`tar`, при желании `ksmbd`) и предлагает установить их.
  - Настраивает временную SMB-шару (`ksmbd`) для удобной выгрузки архива или оставляет файл в `/tmp/archive` для SCP/FTP.
- `openwrt_full_restore`
  - Валидирует архив (`tar -tzf`) и умеет работать в режиме dry-run без изменений на роутере.
  - Перед распаковкой создаёт резервные копии перезаписываемых файлов в `/tmp/openwrt-restore-backup-*`.
  - Распаковывает с сохранением атрибутов, восстанавливает права и владельцев, отслеживает новые и изменённые файлы.
  - Предлагает запустить сохранённый список пакетов и перезапускает ключевые службы (network, wifi, firewall, dnsmasq, dropbear, sqm) при необходимости.
  - Формирует итоговый отчёт со списком действий и путём до резервных копий.
- `user_installed_packages`
  - Генерирует детерминированный список и команды для переустановки вручную установленных `opkg`-пакетов с опциями фильтрации.

## Требования
- Маршрутизатор под управлением OpenWrt ≥ 22.03 с BusyBox ≥ 1.35.0.
- Доступ по SSH (root) или через локальную консоль.
- Свободная оперативная память для хранения архива (как минимум объём, сопоставимый с используемым `/overlay`).
- Доступ в интернет для установки отсутствующих пакетов (опционально, при первом запуске).
- (Опционально) Пакет `ksmbd-server`, если планируется загрузка архива по SMB.

## Установка

### Через пакет .ipk
1. Соберите пакет самостоятельно (см. раздел «Сборка пакета (.ipk)») или скачайте готовый файл `openwrt-extended-backup_*.ipk`.
2. Передайте его на роутер, например:
   ```sh
   scp dist/openwrt-extended-backup_*.ipk root@<ip_роутера>:/tmp/
   ```
3. Установите пакет:
   ```sh
   opkg install /tmp/openwrt-extended-backup_*.ipk
   ```

Скрипты устанавливаются в `/usr/sbin/` и становятся доступны по именам `openwrt_full_backup`, `openwrt_full_restore` и `user_installed_packages`. По умолчанию вместе с пакетом будет установлена зависимость `ksmbd-tools`; чтобы исключить её, соберите пакет с параметром `WITH_KSMBD=0`.

### Ручная установка скриптов
```sh
# Основной скрипт резервного копирования
wget https://raw.githubusercontent.com/nagual2/openwrt-extended-backup/main/scripts/openwrt_full_backup -O /backup
chmod +x /backup

# Скрипт восстановления (необязательно, но рекомендуется)
wget https://raw.githubusercontent.com/nagual2/openwrt-extended-backup/main/scripts/openwrt_full_restore -O /restore
chmod +x /restore

# Вспомогательный список пользовательских пакетов
wget https://raw.githubusercontent.com/nagual2/openwrt-extended-backup/main/scripts/user_installed_packages -O /usr/bin/user_installed_packages
chmod +x /usr/bin/user_installed_packages
```

При ручной установке скрипты `/backup` и `/restore` можно запускать напрямую — они хранятся в постоянной памяти и остаются доступными после перезагрузки.

## Сборка пакета (.ipk)

### Через OpenWrt buildroot/SDK
1. Подключите репозиторий как feed (например, добавьте строку `src-git extended_backup https://github.com/nagual2/openwrt-extended-backup.git` в `feeds.conf`) или скопируйте каталог `openwrt/` из этого репозитория в `package/openwrt-extended-backup` внутри сборочной среды.
2. Если используете feeds, обновите и установите пакет:
   ```sh
   ./scripts/feeds update extended_backup
   ./scripts/feeds install openwrt-extended-backup
   ```
   При ручном копировании каталога этот шаг можно пропустить.
3. При необходимости отключите зависимость `ksmbd-tools` через `make menuconfig` (Utilities → openwrt-extended-backup).
4. Соберите пакет:
   ```sh
   make package/openwrt-extended-backup/compile V=sc
   ```

Готовый `ipk` окажется в каталоге `bin/packages/<архитектура>/packages/`.

### Локальная сборка без SDK

В корне проекта доступен упрощённый `Makefile`:

```sh
make ipk              # соберёт dist/openwrt-extended-backup_<версия>-1_all.ipk
make ipk WITH_KSMBD=0 # исключить зависимость на ksmbd-tools
make install          # установит пакет через opkg, если утилита доступна на хосте
```

Достаточно стандартных утилит `tar` и `ar`. Готовые файлы появляются в каталоге `dist/`.

## Быстрый старт
1. Подключитесь к роутеру по SSH и запустите `./backup` или `/backup`.
2. Подтвердите установку `ksmbd`, если нужен SMB-доступ (по умолчанию ответ «Y»/Enter). При отказе архив всё равно создаётся в `/tmp/archive`.
3. Дождитесь сообщения об успешном завершении и получите архив:
   - по SMB: `\\<ip_роутера>\owrt_archive` (логин `RR`, пароль `12345`);
   - по SCP: `scp root@<ip_роутера>:/tmp/archive/fullbackup_*.tar.gz ./`.
4. Сохраните файл в надёжном месте и удалите его на роутере после выгрузки.
5. (Опционально) Выполните `user_installed_packages` для генерации списка вручную установленных пакетов.
6. Для восстановления воспользуйтесь `openwrt_full_restore --archive /tmp/fullbackup_*.tar.gz` (доступен режим dry-run и автоматическая переустановка пакетов).

## Опции CLI
| Скрипт | Опции | Поведение |
| --- | --- | --- |
| `openwrt_full_backup` | `-V`, `--version` | Выводит текущую версию утилиты и завершает выполнение. |
| `openwrt_full_backup` | без аргументов | Работает интерактивно и спрашивает только о необходимости установки `ksmbd`. |
| `openwrt_full_restore` | `-h`, `--help` | Выводит краткую справку по доступным опциям. |
| `openwrt_full_restore` | `-V`, `--version` | Показывает версию и завершает выполнение. |
| `openwrt_full_restore` | `-a`, `--archive PATH` | Использует указанный архив; без параметра запросит путь интерактивно. |
| `openwrt_full_restore` | `-d`, `--dry-run` | Выполняет проверку архива и формирует отчёт без изменений в системе. |
| `openwrt_full_restore` | `-p`, `--packages PATH` | После распаковки запускает скрипт переустановки пакетов по указанному пути. |
| `openwrt_full_restore` | `--no-packages` | Пропускает шаг с переустановкой пакетов и не задаёт вопрос. |
| `openwrt_full_restore` | `-y`, `--yes` | Автоматически подтверждает действия (без дополнительных вопросов). |
| `user_installed_packages` | `-h`, `--help` | Выводит краткую справку и перечисление доступных опций. |
| `user_installed_packages` | `-V`, `--version` | Выводит текущую версию утилиты и завершает выполнение. |
| `user_installed_packages` | `--status-file PATH` | Использует альтернативный `opkg` статус-файл (например, для тестов). |
| `user_installed_packages` | `--user-installed-file PATH` | Добавляет пакеты из произвольного списка (по одному имени на строку). |
| `user_installed_packages` | `-x`, `--exclude PATTERN` | Исключает пакеты по шаблону (аргумент можно повторять). |
| `user_installed_packages` | `--include-auto-deps` | Включает зависимости, помеченные `Auto-Installed: yes`. |
| `user_installed_packages` | без аргументов | Анализирует текущую систему и выводит отсортированные команды `opkg update` и `opkg install …`. |

## Версионирование и релизы
- Текущая версия хранится в файле `VERSION` в корне репозитория.
- Оба скрипта поддерживают флаги `-V`/`--version` для быстрого вывода версии без запуска основной логики.
- Workflow [`Release`](.github/workflows/release.yml) использует [release-please](https://github.com/googleapis/release-please) для формирования GitHub Releases, обновления `CHANGELOG.md` и автоматической публикации архивов со скриптами.

## Примеры
### SMB/ksmbd
```sh
/backup
# Нажмите Enter, чтобы разрешить установку и настройку ksmbd
smbclient //192.168.1.1/owrt_archive -U RR%12345 -c 'ls'
# Скопируйте архив локально
smbclient //192.168.1.1/owrt_archive -U RR%12345 -c 'get fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz'
```
После копирования отключите шару (через LuCI или `/etc/init.d/ksmbd stop`) и удалите архив:
```sh
rm -f /tmp/archive/fullbackup_*
```

### Альтернатива: SCP
```sh
/backup
# Если SMB не нужен — ответьте «n» на запрос установки ksmbd
scp root@192.168.1.1:/tmp/archive/fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz ./
```
Можно использовать любой другой инструмент: `rsync`, `wget`, графические SCP-клиенты и т. д.

### Восстановление и dry-run
```sh
# Проверяем архив без внесения изменений
openwrt_full_restore --dry-run --archive /tmp/fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz

# Применяем восстановление с автоматическим подтверждением и переустановкой пакетов
openwrt_full_restore --yes --archive /tmp/fullbackup_OpenWrt_23.05.3_2024-10-15_22.11.tar.gz --packages /tmp/opkg-user-packages.sh
```
После применения проверьте отчёт: он покажет путь к резервным копиям перезаписанных файлов (`/tmp/openwrt-restore-backup-*`) и список служб, которые были перезапущены.

### Список пользовательских пакетов
```sh
user_installed_packages > /tmp/opkg-user-packages.sh
scp root@192.168.1.1:/tmp/opkg-user-packages.sh ./
```
Скрипт анализирует `/usr/lib/opkg/status`, исключает базовые пакеты с минимальным временем установки прошивки и зависимости, помеченные `Auto-Installed: yes`, а при наличии дополняет результат данными из списка `user-installed`. На выходе получается детерминированный список и готовые команды для переустановки:

```text
# user-installed opkg packages (7)
# main packages (6)
bash
htop
luci-app-sqm
luci-theme-material
smartmontools
tailscale

# LuCI translations (1)
luci-i18n-firewall-ru

opkg update
opkg install bash htop luci-app-sqm luci-theme-material smartmontools tailscale
opkg install luci-i18n-firewall-ru
```

Можно, например, скрыть локализации (`user_installed_packages --exclude 'luci-i18n-*'`) или вернуть зависимости, помеченные `Auto-Installed: yes` (`user_installed_packages --include-auto-deps`).

## Меры безопасности
- Используйте SMB-шару только в доверенной сети. После копирования архива остановите `ksmbd` и удалите созданного пользователя: `ksmbd.deluser RR`.
- Смените пароль для SMB-шары вручную, если планируете использовать её повторно.
- Не храните архив на самом роутере дольше, чем необходимо.
- Поскольку архив содержит все настройки и пароли, держите его в зашифрованном или защищённом хранилище.
- Обновляйте OpenWrt и пакеты безопасности до актуальных версий перед созданием резервных копий.

## Ограничения и что не бэкапится
- Архив сохраняется в оперативной памяти (`/tmp/archive`) и исчезает после перезагрузки.
- Резервная копия рассчитана на восстановление **на ту же версию прошивки**. Межверсийное восстановление не гарантируется.
- Не архивируются временные рабочие каталоги (`/overlay/work`, `run`) и системные файлы `os-release`, исключённые намеренно.
- В архив не попадают данные с внешних накопителей (`/mnt`, `/dev/sdX`) — их нужно копировать отдельно.
- Скрипт не выполняет шифрование и проверку целостности архива — рекомендуется проверять `tar -tzf` вручную.
- Для работы требуется установленная утилита `tar`; при отсутствии интернет-доступа её автоустановка будет невозможна.

## Проверенные версии OpenWrt и BusyBox
| OpenWrt | BusyBox | Примечание |
| --- | --- | --- |
| 23.05.3 | 1.36.1 | Ручная проверка на x86-64 и MT7621. |
| 22.03.5 | 1.35.0 | Проверено на MT7620A/ramips. |

Если у вас получилось успешно использовать скрипты на других версиях — дайте знать через Issue или Pull Request.

## Руководства
- [Подробное восстановление из резервной копии](docs/restore-guide.md)

---

Скрипты распространяются «как есть». Будем рады обратной связи и улучшениям через Pull Request.
