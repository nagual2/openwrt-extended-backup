[1mdiff --git a/scripts/openwrt_full_backup b/scripts/openwrt_full_backup[m
[1mindex 71c8e02..49b5ab4 100755[m
[1m--- a/scripts/openwrt_full_backup[m
[1m+++ b/scripts/openwrt_full_backup[m
[36m@@ -59,6 +59,47 @@[m [mARCHIVE_FILENAME=''[m
 ARCHIVE_PATH=''[m
 REMOVE_ARCHIVE_ON_FAILURE=0[m
 [m
[32m+[m[32mDRY_RUN_ENABLED=0[m
[32m+[m[32mif [ "${DRY_RUN+x}" = x ]; then[m
[32m+[m[32m    case "$DRY_RUN" in[m
[32m+[m[32m        '' | 0 | [Ff][Aa][Ll][Ss][Ee] | [Nn][Oo] | [Oo][Ff][Ff])[m
[32m+[m[32m            DRY_RUN_ENABLED=0[m
[32m+[m[32m            ;;[m
[32m+[m[32m        *)[m
[32m+[m[32m            DRY_RUN_ENABLED=1[m
[32m+[m[32m            ;;[m
[32m+[m[32m    esac[m
[32m+[m[32mfi[m
[32m+[m
[32m+[m[32mUPLOAD_TARGET=''[m
[32m+[m[32mUPLOAD_SCHEME=''[m
[32m+[m[32mUPLOAD_REMOTE_SPEC=''[m
[32m+[m[32mUPLOAD_USER_HOST=''[m
[32m+[m[32mUPLOAD_REMOTE_PATH=''[m
[32m+[m[32mIDENTITY_FILE=''[m
[32m+[m[32mKNOWN_HOSTS_FILE=''[m
[32m+[m[32mUPLOAD_RETRY=1[m
[32m+[m
[32m+[m[32mDEFAULT_OVERLAY_DIR='/overlay'[m
[32m+[m[32mif [ "${OVERLAY_SOURCE+x}" = x ] && [ -n "$OVERLAY_SOURCE" ]; then[m
[32m+[m[32m    case "$OVERLAY_SOURCE" in[m
[32m+[m[32m        /)[m
[32m+[m[32m            OVERLAY_PATH='/'[m
[32m+[m[32m            ;;[m
[32m+[m[32m        */)[m
[32m+[m[32m            OVERLAY_PATH=${OVERLAY_SOURCE%/}[m
[32m+[m[32m            ;;[m
[32m+[m[32m        *)[m
[32m+[m[32m            OVERLAY_PATH=$OVERLAY_SOURCE[m
[32m+[m[32m            ;;[m
[32m+[m[32m    esac[m
[32m+[m[32m    if [ -z "$OVERLAY_PATH" ]; then[m
[32m+[m[32m        OVERLAY_PATH=$DEFAULT_OVERLAY_DIR[m
[32m+[m[32m    fi[m
[32m+[m[32melse[m
[32m+[m[32m    OVERLAY_PATH=$DEFAULT_OVERLAY_DIR[m
[32m+[m[32mfi[m
[32m+[m
 KSMBD_SHARE_NAME='owrt_archive'[m
 KSMBD_USER='owrt_backup'[m
 KSMBD_PASSWORD=''[m
[36m@@ -109,16 +150,22 @@[m [musage() {[m
 Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: openwrt_full_backup [ÐžÐŸÐ¦Ð˜Ð˜][m
 [m
 ÐžÐ¿Ñ†Ð¸Ð¸:[m
[31m-      --export=MODE       Ð ÐµÐ¶Ð¸Ð¼ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°: scp (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ), smb Ð¸Ð»Ð¸ local[m
[31m-      --emit-scp-cmd      Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ scp Ð±ÐµÐ· Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°[m
[31m-      --ssh-host HOST     Ð˜Ð¼Ñ Ð¸Ð»Ð¸ Ð°Ð´Ñ€ÐµÑ OpenWrt-Ñ…Ð¾ÑÑ‚Ð° (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ OpenWrt)[m
[31m-      --ssh-port PORT     ÐŸÐ¾Ñ€Ñ‚ SSH (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 22)[m
[31m-      --ssh-user USER     ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ SSH (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ root)[m
[31m-      --out-dir PATH      ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð´Ð»Ñ Ð°Ñ€Ñ…Ð¸Ð²Ð° (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ /tmp)[m
[31m-  -q, --quiet             Ð ÐµÐ¶Ð¸Ð¼ Ñ‚Ð¸Ñ…Ð¾Ð³Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾ÑˆÐ¸Ð±ÐºÐ¸)[m
[31m-  -v                      Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ (Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð´Ð²Ð°Ð¶Ð´Ñ‹)[m
[31m-  -h, --help              ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ Ð¸ Ð²Ñ‹Ð¹Ñ‚Ð¸[m
[31m-  -V, --version           ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸ Ð²Ñ‹Ð¹Ñ‚Ð¸[m
[32m+[m[32m      --export=MODE         Ð ÐµÐ¶Ð¸Ð¼ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°: scp (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ), smb Ð¸Ð»Ð¸ local[m
[32m+[m[32m      --emit-scp-cmd        Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ scp Ð±ÐµÐ· Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÐºÑÑ‚Ð°[m
[32m+[m[32m      --ssh-host HOST       Ð˜Ð¼Ñ Ð¸Ð»Ð¸ Ð°Ð´Ñ€ÐµÑ OpenWrt-Ñ…Ð¾ÑÑ‚Ð° (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ OpenWrt)[m
[32m+[m[32m      --ssh-port PORT       ÐŸÐ¾Ñ€Ñ‚ SSH (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 22)[m
[32m+[m[32m      --ssh-user USER       ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ SSH (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ root)[m
[32m+[m[32m      --output PATH         ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð´Ð»Ñ Ð°Ñ€Ñ…Ð¸Ð²Ð° (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ /tmp)[m
[32m+[m[32m      --out-dir PATH        ÐÐ»Ð¸Ð°Ñ Ð´Ð»Ñ --output (ÑƒÑÑ‚Ð°Ñ€.)[m
[32m+[m[32m      --upload URL          Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° ÑƒÐ´Ð°Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ…Ð¾ÑÑ‚ (scp:// Ð¸Ð»Ð¸ sftp://)[m
[32m+[m[32m      --identity PATH       ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð´Ð»Ñ scp/sftp (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ~/.ssh/id_ed25519)[m
[32m+[m[32m      --known-hosts PATH    ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ñ„Ð°Ð¹Ð» known_hosts Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ»ÑŽÑ‡ÐµÐ¹[m
[32m+[m[32m      --retry COUNT         ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 1)[m
[32m+[m[32m  -n, --dry-run             ÐŸÐ»Ð°Ð½ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð±ÐµÐ· Ð¿Ð¾Ð±Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð² (Ð°Ñ€Ñ…Ð¸Ð² Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ)[m
[32m+[m[32m  -q, --quiet               Ð ÐµÐ¶Ð¸Ð¼ Ñ‚Ð¸Ñ…Ð¾Ð³Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾ÑˆÐ¸Ð±ÐºÐ¸)[m
[32m+[m[32m  -v                        Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ (Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð´Ð²Ð°Ð¶Ð´Ñ‹)[m
[32m+[m[32m  -h, --help                ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ Ð¸ Ð²Ñ‹Ð¹Ñ‚Ð¸[m
[32m+[m[32m  -V, --version             ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸ Ð²Ñ‹Ð¹Ñ‚Ð¸[m
 EOF[m
 }[m
 [m
[36m@@ -139,6 +186,188 @@[m [mto_absolute_path() {[m
     esac[m
 }[m
 [m
[32m+[m[32mparse_upload_target() {[m
[32m+[m[32m    target=$1[m
[32m+[m
[32m+[m[32m    if [ -z "$target" ]; then[m
[32m+[m[32m        fatal 'ÐžÐ¿Ñ†Ð¸Ñ --upload Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ URL (scp:// Ð¸Ð»Ð¸ sftp://)' "$EX_USAGE"[m
[32m+[m[32m    fi[m
[32m+[m
[32m+[m[32m    case "$target" in[m
[32m+[m[32m        scp://*)[m
[32m+[m[32m            rest=${target#scp://}[m
[32m+[m[32m            case "$rest" in[m
[32m+[m[32m                *:*)[m
[32m+[m[32m                    host_part=${rest%%:*}[m
[32m+[m[32m                    path_part=${rest#*:}[m
[32m+[m[32m                    ;;[m
[32m+[m[32m                *)[m
[32m+[m[32m                    fatal 'URL Ð´Ð»Ñ SCP Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ host:path' "$EX_USAGE"[m
[32m+[m[32m                    ;;[m
[32m+[m[32m            esac[m
[32m+[m[32m            if [ -z "$host_part" ] || [ -z "$path_part" ]; then[m
[32m+[m[32m                fatal 'URL Ð´Ð»Ñ SCP Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ host:path' "$EX_USAGE"[m
[32m+[m[32m            fi[m
[32m+[m[32m            UPLOAD_TARGET=$target[m
[32m+[m[32m            UPLOAD_SCHEME='scp'[m
[32m+[m[32m            UPLOAD_USER_HOST=$host_part[m
[32m+[m[32m            UPLOAD_REMOTE_PATH=$path_part[m
[32m+[m[32m            UPLOAD_REMOTE_SPEC="$UPLOAD_USER_HOST:$UPLOAD_REMOTE_PATH"[m
[32m+[m[32m            ;;[m
[32m+[m[32m        sftp://*)[m
[32m+[m[32m            rest=${target#sftp://}[m
[32m+[m[32m            case "$rest" in[m
[32m+[m[32m                *:*)[m
[32m+[m[32m                    host_part=${rest%%:*}[m
[32m+[m[32m                    path_part=${rest#*:}[m
[32m+[m[32m                    ;;[m
[32m+[m[32m                *)[m
[32m+[m[32m                    fatal 'URL Ð´Ð»Ñ SFTP Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ host:/Ð¿ÑƒÑ‚ÑŒ' "$EX_USAGE"[m
[32m+[m[32m                    ;;[m
[32m+[m[32m            esac[m
[32m+[m[32m            if [ -z "$host_part" ] || [ -z "$path_part" ]; then[m
[32m+[m[32m                fatal 'URL Ð´Ð»Ñ SFTP Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ host:/Ð¿ÑƒÑ‚ÑŒ' "$EX_USAGE"[m
[32m+[m[32m            fi[m
[32m+[m[32m            UPLOAD_TARGET=$target[m
[32m+[m[32m            UPLOAD_SCHEME='sftp'[m
[32m+[m[32m            UPLOAD_USER_HOST=$host_part[m
[32m+[m[32m            UPLOAD_REMOTE_PATH=$path_part[m
[32m+[m[32m            UPLOAD_REMOTE_SPEC=$UPLOAD_REMOTE_PATH[m
[32m+[m[32m            ;;[m
[32m+[m[32m        *)[m
[32m+[m[32m            fatal "ÐÐµÐ¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ð°Ñ ÑÑ…ÐµÐ¼Ð° Ð´Ð»Ñ --upload: $target" "$EX_USAGE"[m
[32m+[m[32m            ;;[m
[32m+[m[32m    esac[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mprepare_upload_environment() {[m
[32m+[m[32m    if [ -z "$UPLOAD_TARGET" ]; then[m
[32m+[m[32m        return 0[m
[32m+[m[32m    fi[m
[32m+[m
[32m+[m[32m    case "$UPLOAD_SCHEME" in[m
[32m+[m[32m        scp)[m
[32m+[m[32m            require_command scp[m
[32m+[m[32m            ;;[m
[32m+[m[32m        sftp)[m
[32m+[m[32m            require_command sftp[m
[32m+[m[32m            ;;[m
[32m+[m[32m    esac[m
[32m+[m
[32m+[m[32m    if [ -n "$IDENTITY_FILE" ] && [ ! -r "$IDENTITY_FILE" ]; then[m
[32m+[m[32m        fatal "Ð¤Ð°Ð¹Ð» Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½: $IDENTITY_FILE" "$EX_UNAVAILABLE"[m
[32m+[m[32m    fi[m
[32m+[m
[32m+[m[32m    if [ -n "$KNOWN_HOSTS_FILE" ] && [ ! -r "$KNOWN_HOSTS_FILE" ]; then[m
[32m+[m[32m        fatal "Ð¤Ð°Ð¹Ð» known_hosts Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½: $KNOWN_HOSTS_FILE" "$EX_UNAVAILABLE"[m
[32m+[m[32m    fi[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mbuild_scp_preview() {[m
[32m+[m[32m    command_text='scp'[m
[32m+[m[32m    if [ "$SSH_PORT" != '22' ]; then[m
[32m+[m[32m        command_text="$command_text -P $SSH_PORT"[m
[32m+[m[32m    fi[m
[32m+[m[32m    if [ -n "$IDENTITY_FILE" ]; then[m
[32m+[m[32m        command_text="$command_text -i $IDENTITY_FILE"[m
[32m+[m[32m    fi[m
[32m+[m[32m    command_text="$command_text -o StrictHostKeyChecking=yes"[m
[32m+[m[32m    if [ -n "$KNOWN_HOSTS_FILE" ]; then[m
[32m+[m[32m        command_text="$command_text -o UserKnownHostsFile=$KNOWN_HOSTS_FILE"[m
[32m+[m[32m    fi[m
[32m+[m[32m    command_text="$command_text $ARCHIVE_PATH"[m
[32m+[m[32m    if [ -n "$UPLOAD_REMOTE_SPEC" ]; then[m
[32m+[m[32m        command_text="$command_text $UPLOAD_REMOTE_SPEC"[m
[32m+[m[32m    fi[m
[32m+[m[32m    printf '%s\n' "$command_text"[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mrun_with_retries() {[m
[32m+[m[32m    max_attempts=$1[m
[32m+[m[32m    shift[m
[32m+[m[32m    attempt=1[m
[32m+[m[32m    status=0[m
[32m+[m[32m    while [ "$attempt" -le "$max_attempts" ]; do[m
[32m+[m[32m        if "$@"; then[m
[32m+[m[32m            return 0[m
[32m+[m[32m        fi[m
[32m+[m[32m        status=$?[m
[32m+[m[32m        if [ "$attempt" -ge "$max_attempts" ]; then[m
[32m+[m[32m            return "$status"[m
[32m+[m[32m        fi[m
[32m+[m[32m        attempt=$((attempt + 1))[m
[32m+[m[32m        log_info "ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ($attempt/$max_attempts)"[m
[32m+[m[32m    done[m
[32m+[m[32m    return "$status"[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mperform_upload() {[m
[32m+[m[32m    if [ -z "$UPLOAD_TARGET" ]; then[m
[32m+[m[32m        return 0[m
[32m+[m[32m    fi[m
[32m+[m
[32m+[m[32m    if [ "$UPLOAD_SCHEME" = 'scp' ]; then[m
[32m+[m[32m        if [ "$DRY_RUN_ENABLED" -eq 1 ]; then[m
[32m+[m[32m            log_info 'Ð ÐµÐ¶Ð¸Ð¼ dry-run: Ð³Ð¾Ñ‚Ð¾Ð²Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° SCP'[m
[32m+[m[32m            log_info "$(build_scp_preview)"[m
[32m+[m[32m            return 0[m
[32m+[m[32m        fi[m
[32m+[m
[32m+[m[32m        set -- scp[m
[32m+[m[32m        if [ "$SSH_PORT" != '22' ]; then[m
[32m+[m[32m            set -- "$@" -P "$SSH_PORT"[m
[32m+[m[32m        fi[m
[32m+[m[32m        if [ -n "$IDENTITY_FILE" ]; then[m
[32m+[m[32m            set -- "$@" -i "$IDENTITY_FILE"[m
[32m+[m[32m        fi[m
[32m+[m[32m        set -- "$@" -o StrictHostKeyChecking=yes[m
[32m+[m[32m        if [ -n "$KNOWN_HOSTS_FILE" ]; then[m
[32m+[m[32m            set -- "$@" -o "UserKnownHostsFile=$KNOWN_HOSTS_FILE"[m
[32m+[m[32m        fi[m
[32m+[m[32m        set -- "$@" "$ARCHIVE_PATH" "$UPLOAD_REMOTE_SPEC"[m
[32m+[m
[32m+[m[32m        log_info "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð° Ñ‡ÐµÑ€ÐµÐ· SCP: $UPLOAD_REMOTE_SPEC"[m
[32m+[m[32m        run_with_retries "$UPLOAD_RETRY" "$@"[m
[32m+[m[32m        status=$?[m
[32m+[m[32m        return "$status"[m
[32m+[m[32m    fi[m
[32m+[m
[32m+[m[32m    if [ "$UPLOAD_SCHEME" = 'sftp' ]; then[m
[32m+[m[32m        if [ "$DRY_RUN_ENABLED" -eq 1 ]; then[m
[32m+[m[32m            log_info 'Ð ÐµÐ¶Ð¸Ð¼ dry-run: Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· SFTP (ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° put)'[m
[32m+[m[32m            log_info "put \"$ARCHIVE_PATH\" \"$UPLOAD_REMOTE_PATH\""[m
[32m+[m[32m            return 0[m
[32m+[m[32m        fi[m
[32m+[m
[32m+[m[32m        batch_file=$(mktemp)[m
[32m+[m[32m        if [ -z "$batch_file" ]; then[m
[32m+[m[32m            fatal 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ SFTP' "$EX_SOFTWARE"[m
[32m+[m[32m        fi[m
[32m+[m[32m        printf 'put "%s" "%s"\n' "$ARCHIVE_PATH" "$UPLOAD_REMOTE_PATH" >"$batch_file"[m
[32m+[m
[32m+[m[32m        set -- sftp[m
[32m+[m[32m        if [ -n "$IDENTITY_FILE" ]; then[m
[32m+[m[32m            set -- "$@" -i "$IDENTITY_FILE"[m
[32m+[m[32m        fi[m
[32m+[m[32m        if [ "$SSH_PORT" != '22' ]; then[m
[32m+[m[32m            set -- "$@" -P "$SSH_PORT"[m
[32m+[m[32m        fi[m
[32m+[m[32m        set -- "$@" -o StrictHostKeyChecking=yes[m
[32m+[m[32m        if [ -n "$KNOWN_HOSTS_FILE" ]; then[m
[32m+[m[32m            set -- "$@" -o "UserKnownHostsFile=$KNOWN_HOSTS_FILE"[m
[32m+[m[32m        fi[m
[32m+[m[32m        set -- "$@" -b "$batch_file" "$UPLOAD_USER_HOST"[m
[32m+[m
[32m+[m[32m        log_info "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð° Ñ‡ÐµÑ€ÐµÐ· SFTP: $UPLOAD_USER_HOST -> $UPLOAD_REMOTE_PATH"[m
[32m+[m[32m        run_with_retries "$UPLOAD_RETRY" "$@"[m
[32m+[m[32m        status=$?[m
[32m+[m[32m        rm -f "$batch_file"[m
[32m+[m[32m        return "$status"[m
[32m+[m[32m    fi[m
[32m+[m
[32m+[m[32m    return 0[m
[32m+[m[32m}[m
[32m+[m
 find_share_index_by_name() {[m
     name=$1[m
     share_indexes=$(uci -q show ksmbd | sed -n 's/^ksmbd\.@share\[\([0-9]\+\)\]=share$/\1/p')[m
[36m@@ -222,6 +451,13 @@[m [mparse_args() {[m
                 shift || fatal 'ÐžÐ¿Ñ†Ð¸Ñ --ssh-user Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚' "$EX_USAGE"[m
                 SSH_USER=$1[m
                 ;;[m
[32m+[m[32m            --output=*)[m
[32m+[m[32m                OUT_DIR=${1#--output=}[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --output)[m
[32m+[m[32m                shift || fatal 'ÐžÐ¿Ñ†Ð¸Ñ --output Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚' "$EX_USAGE"[m
[32m+[m[32m                OUT_DIR=$1[m
[32m+[m[32m                ;;[m
             --out-dir=*)[m
                 OUT_DIR=${1#--out-dir=}[m
                 ;;[m
[36m@@ -229,6 +465,48 @@[m [mparse_args() {[m
                 shift || fatal 'ÐžÐ¿Ñ†Ð¸Ñ --out-dir Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚' "$EX_USAGE"[m
                 OUT_DIR=$1[m
                 ;;[m
[32m+[m[32m            --upload=*)[m
[32m+[m[32m                parse_upload_target "${1#--upload=}"[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --upload)[m
[32m+[m[32m                shift || fatal 'ÐžÐ¿Ñ†Ð¸Ñ --upload Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ URL' "$EX_USAGE"[m
[32m+[m[32m                parse_upload_target "$1"[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --identity=*)[m
[32m+[m[32m                IDENTITY_FILE=${1#--identity=}[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --identity)[m
[32m+[m[32m                shift || fatal 'ÐžÐ¿Ñ†Ð¸Ñ --identity Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ' "$EX_USAGE"[m
[32m+[m[32m                IDENTITY_FILE=$1[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --known-hosts=*)[m
[32m+[m[32m                KNOWN_HOSTS_FILE=${1#--known-hosts=}[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --known-hosts)[m
[32m+[m[32m                shift || fatal 'ÐžÐ¿Ñ†Ð¸Ñ --known-hosts Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ' "$EX_USAGE"[m
[32m+[m[32m                KNOWN_HOSTS_FILE=$1[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --retry=*)[m
[32m+[m[32m                UPLOAD_RETRY=${1#--retry=}[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --retry)[m
[32m+[m[32m                shift || fatal 'ÐžÐ¿Ñ†Ð¸Ñ --retry Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾' "$EX_USAGE"[m
[32m+[m[32m                UPLOAD_RETRY=$1[m
[32m+[m[32m                ;;[m
[32m+[m[32m            -n | --dry-run)[m
[32m+[m[32m                DRY_RUN_ENABLED=1[m
[32m+[m[32m                ;;[m
[32m+[m[32m            --dry-run=*)[m
[32m+[m[32m                value=${1#--dry-run=}[m
[32m+[m[32m                case "$value" in[m
[32m+[m[32m                    '' | 0 | [Ff][Aa][Ll][Ss][Ee] | [Nn][Oo] | [Oo][Ff][Ff])[m
[32m+[m[32m                        DRY_RUN_ENABLED=0[m
[32m+[m[32m                        ;;[m
[32m+[m[32m                    *)[m
[32m+[m[32m                        DRY_RUN_ENABLED=1[m
[32m+[m[32m                        ;;[m
[32m+[m[32m                esac[m
[32m+[m[32m                ;;[m
             -v)[m
                 if [ "$LOG_LEVEL" -lt 2 ]; then[m
                     LOG_LEVEL=$((LOG_LEVEL + 1))[m
[36m@@ -276,6 +554,15 @@[m [mparse_args() {[m
             ;;[m
     esac[m
 [m
[32m+[m[32m    case "$UPLOAD_RETRY" in[m
[32m+[m[32m        '' | *[!0-9]*)[m
[32m+[m[32m            fatal 'ÐžÐ¿Ñ†Ð¸Ñ --retry Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼' "$EX_USAGE"[m
[32m+[m[32m            ;;[m
[32m+[m[32m        0)[m
[32m+[m[32m            fatal 'ÐžÐ¿Ñ†Ð¸Ñ --retry Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ >= 1' "$EX_USAGE"[m
[32m+[m[32m            ;;[m
[32m+[m[32m    esac[m
[32m+[m
     OUT_DIR=$(to_absolute_path "$OUT_DIR")[m
 }[m
 [m
[36m@@ -314,12 +601,18 @@[m [mprepare_environment() {[m
         log_debug 'Ð ÐµÐ¶Ð¸Ð¼ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°: local'[m
     fi[m
 [m
[31m-    if ! mkdir -p "$OUT_DIR"; then[m
[31m-        fatal "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³: $OUT_DIR" "$EX_SOFTWARE"[m
[31m-    fi[m
[32m+[m[32m    if [ "$DRY_RUN_ENABLED" -eq 0 ]; then[m
[32m+[m[32m        if ! mkdir -p "$OUT_DIR"; then[m
[32m+[m[32m            fatal "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³: $OUT_DIR" "$EX_SOFTWARE"[m
[32m+[m[32m        fi[m
[32m+[m
[32m+[m[32m        if [ ! -w "$OUT_DIR" ]; then[m
[32m+[m[32m            fatal "ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸: $OUT_DIR" "$EX_SOFTWARE"[m
[32m+[m[32m        fi[m
 [m
[31m-    if [ ! -w "$OUT_DIR" ]; then[m
[31m-        fatal "ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸: $OUT_DIR" "$EX_SOFTWARE"[m
[32m+[m[32m        if [ ! -d "$OVERLAY_PATH" ]; then[m
[32m+[m[32m            fatal "ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ð´Ð»Ñ Ð°Ñ€Ñ…Ð¸Ð²Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $OVERLAY_PATH" "$EX_SOFTWARE"[m
[32m+[m[32m        fi[m
     fi[m
 }[m
 [m
[36m@@ -333,17 +626,43 @@[m [mcreate_archive() {[m
         fatal "Ð¤Ð°Ð¹Ð» ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚: $ARCHIVE_PATH" "$EX_SOFTWARE"[m
     fi[m
 [m
[32m+[m[32m    case "$OVERLAY_PATH" in[m
[32m+[m[32m        /)[m
[32m+[m[32m            overlay_base='/'[m
[32m+[m[32m            exclude_work='/work'[m
[32m+[m[32m            exclude_run='/upper/run'[m
[32m+[m[32m            exclude_os_release='/upper/etc/os-release'[m
[32m+[m[32m            exclude_usr_os_release='/upper/usr/lib/os-release'[m
[32m+[m[32m            ;;[m
[32m+[m[32m        *)[m
[32m+[m[32m            overlay_base=${OVERLAY_PATH%/}[m
[32m+[m[32m            if [ -z "$overlay_base" ]; then[m
[32m+[m[32m                overlay_base='/overlay'[m
[32m+[m[32m            fi[m
[32m+[m[32m            exclude_work="$overlay_base/work"[m
[32m+[m[32m            exclude_run="$overlay_base/upper/run"[m
[32m+[m[32m            exclude_os_release="$overlay_base/upper/etc/os-release"[m
[32m+[m[32m            exclude_usr_os_release="$overlay_base/upper/usr/lib/os-release"[m
[32m+[m[32m            ;;[m
[32m+[m[32m    esac[m
[32m+[m
[32m+[m[32m    if [ "$DRY_RUN_ENABLED" -eq 1 ]; then[m
[32m+[m[32m        log_info 'Ð ÐµÐ¶Ð¸Ð¼ dry-run: Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð±ÐµÐ· Ð¿Ð¾Ð±Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð²'[m
[32m+[m[32m        log_info "Ð ÐµÐ¶Ð¸Ð¼ dry-run: Ð°Ñ€Ñ…Ð¸Ð² Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð»ÑÑ (Ð·Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ: $ARCHIVE_PATH)"[m
[32m+[m[32m        return 0[m
[32m+[m[32m    fi[m
[32m+[m
     log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð°: $ARCHIVE_PATH"[m
     REMOVE_ARCHIVE_ON_FAILURE=1[m
 [m
     if ! tar -czpf "$ARCHIVE_PATH" \[m
         --preserve-permissions \[m
         --same-owner \[m
[31m-        --exclude='/overlay/work' \[m
[31m-        --exclude='/overlay/upper/run' \[m
[31m-        --exclude='/overlay/upper/etc/os-release' \[m
[31m-        --exclude='/overlay/upper/usr/lib/os-release' \[m
[31m-        /overlay; then[m
[32m+[m[32m        --exclude="$exclude_work" \[m
[32m+[m[32m        --exclude="$exclude_run" \[m
[32m+[m[32m        --exclude="$exclude_os_release" \[m
[32m+[m[32m        --exclude="$exclude_usr_os_release" \[m
[32m+[m[32m        "$overlay_base"; then[m
         fatal 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð°Ñ€Ñ…Ð¸Ð²' "$EX_SOFTWARE"[m
     fi[m
 [m
[36m@@ -383,6 +702,11 @@[m [mgenerate_password() {[m
 }[m
 [m
 setup_smb_export() {[m
[32m+[m[32m    if [ "$DRY_RUN_ENABLED" -eq 1 ]; then[m
[32m+[m[32m        log_info 'Ð ÐµÐ¶Ð¸Ð¼ dry-run: SMB-ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑ‚ÑÑ'[m
[32m+[m[32m        return 0[m
[32m+[m[32m    fi[m
[32m+[m
     ensure_ksmbd_dependencies[m
 [m
     if [ -z "$KSMBD_PASSWORD" ]; then[m
[36m@@ -490,8 +814,16 @@[m [memit_scp_instruction() {[m
 parse_args "$@"[m
 [m
 prepare_environment[m
[32m+[m[32mprepare_upload_environment[m
[32m+[m
 create_archive[m
 [m
[32m+[m[32mperform_upload[m
[32m+[m[32mupload_status=$?[m
[32m+[m[32mif [ "$upload_status" -ne 0 ]; then[m
[32m+[m[32m    exit "$upload_status"[m
[32m+[m[32mfi[m
[32m+[m
 case "$EXPORT_MODE" in[m
     scp)[m
         emit_scp_instruction[m
[36m@@ -500,7 +832,9 @@[m [mcase "$EXPORT_MODE" in[m
         setup_smb_export[m
         ;;[m
     local)[m
[31m-        log_info "ÐÑ€Ñ…Ð¸Ð² ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð² $ARCHIVE_PATH"[m
[32m+[m[32m        if [ "$DRY_RUN_ENABLED" -eq 0 ]; then[m
[32m+[m[32m            log_info "ÐÑ€Ñ…Ð¸Ð² ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð² $ARCHIVE_PATH"[m
[32m+[m[32m        fi[m
         ;;[m
 esac[m
 [m
[1mdiff --git a/tests/openwrt_full_backup.bats b/tests/openwrt_full_backup.bats[m
[1mindex cc466fc..190744f 100644[m
[1m--- a/tests/openwrt_full_backup.bats[m
[1m+++ b/tests/openwrt_full_backup.bats[m
[36m@@ -3,21 +3,21 @@[m
 setup() {[m
     PROJECT_ROOT=$(cd "$BATS_TEST_DIRNAME/.." 2>/dev/null && pwd)[m
     SCRIPT_PATH="$PROJECT_ROOT/scripts/openwrt_full_backup"[m
[31m-<<<<<<< HEAD[m
 [m
     PATH_ORIG=$PATH[m
     TEST_ROOT=$(mktemp -d)[m
     BIN_DIR="$TEST_ROOT/bin"[m
     mkdir -p "$BIN_DIR"[m
[31m-    export PATH="$BIN_DIR:$PATH_ORIG"[m
[32m+[m[32m    PATH="$BIN_DIR:$PATH_ORIG"[m
[32m+[m[32m    export PATH[m
 [m
     REAL_DATE=$(command -v date)[m
     cat >"$BIN_DIR/date" <<EOF[m
 #!/bin/sh[m
[31m-if [ "\$#" -eq 0 ]; then[m
[32m+[m[32mif [ "$#" -eq 0 ]; then[m
     exec "$REAL_DATE"[m
 fi[m
[31m-case "\$1" in[m
[32m+[m[32mcase "$1" in[m
     '+%Y-%m-%d %H:%M:%S')[m
         printf '2024-01-01 00:00:00\n'[m
         ;;[m
[36m@@ -28,7 +28,7 @@[m [mcase "\$1" in[m
         printf '000000\n'[m
         ;;[m
     *)[m
[31m-        exec "$REAL_DATE" "\$@"[m
[32m+[m[32m        exec "$REAL_DATE" "$@"[m
         ;;[m
 esac[m
 EOF[m
[36m@@ -37,15 +37,15 @@[m [mEOF[m
     REAL_UNAME=$(command -v uname)[m
     cat >"$BIN_DIR/uname" <<EOF[m
 #!/bin/sh[m
[31m-if [ "\$#" -gt 0 ]; then[m
[31m-    case "\$1" in[m
[32m+[m[32mif [ "$#" -gt 0 ]; then[m
[32m+[m[32m    case "$1" in[m
         -n)[m
             printf 'TestRouter\n'[m
             exit 0[m
             ;;[m
     esac[m
 fi[m
[31m-exec "$REAL_UNAME" "\$@"[m
[32m+[m[32mexec "$REAL_UNAME" "$@"[m
 EOF[m
     chmod +x "$BIN_DIR/uname"[m
 [m
[36m@@ -100,7 +100,6 @@[m [mEOF[m
     export OVERLAY_SOURCE="$OVERLAY_DIR"[m
 [m
     OUT_DIR="$TEST_ROOT/out"[m
[31m-    mkdir -p "$OUT_DIR"[m
     EXPECTED_ARCHIVE="$OUT_DIR/fullbackup_TestRouter_2024-01-01_00-00-00.tar.gz"[m
 }[m
 [m
[36m@@ -111,6 +110,20 @@[m [mteardown() {[m
         MOCK_UPLOAD_FAIL_FILE MOCK_UPLOAD_FAIL_CODE MOCK_UPLOAD_EXIT_CODE[m
 }[m
 [m
[32m+[m[32mmock_tar_setup() {[m
[32m+[m[32m    MOCK_TAR_DIR="$TEST_ROOT/mock-tar"[m
[32m+[m[32m    mkdir -p "$MOCK_TAR_DIR"[m
[32m+[m[32m    MOCK_TAR_MARKER="$TEST_ROOT/tar-invoked"[m
[32m+[m[32m    rm -f "$MOCK_TAR_MARKER"[m
[32m+[m[32m    cat >"$MOCK_TAR_DIR/tar" <<EOF[m
[32m+[m[32m#!/bin/sh[m
[32m+[m[32mtouch "$MOCK_TAR_MARKER"[m
[32m+[m[32mprintf 'mock tar executed\n' >&2[m
[32m+[m[32mexit 1[m
[32m+[m[32mEOF[m
[32m+[m[32m    chmod +x "$MOCK_TAR_DIR/tar"[m
[32m+[m[32m}[m
[32m+[m
 @test "scp upload invokes scp with provided options" {[m
     identity="$TEST_ROOT/id_ed25519"[m
     known_hosts="$TEST_ROOT/known_hosts"[m
[36m@@ -122,9 +135,9 @@[m [mteardown() {[m
         --upload "scp://backup@example.com:/remote/archive.tar.gz" \[m
         --identity "$identity" \[m
         --known-hosts "$known_hosts" \[m
[31m-        --port 2022 \[m
[32m+[m[32m        --ssh-port 2022 \[m
         --retry 1 \[m
[31m-        --out-dir "$OUT_DIR" \[m
[32m+[m[32m        --output "$OUT_DIR" \[m
         --export=scp[m
 [m
     [ "$status" -eq 0 ][m
[36m@@ -137,7 +150,7 @@[m [mteardown() {[m
     [[ "$command_logged" == *"UserKnownHostsFile=$known_hosts"* ]][m
     [[ "$command_logged" == *"StrictHostKeyChecking=yes"* ]][m
     [[ "$command_logged" == *"$EXPECTED_ARCHIVE"* ]][m
[31m-    [[ "$command_logged" == *"backup@example.com:'/remote/archive.tar.gz'"* ]][m
[32m+[m[32m    [[ "$command_logged" == *"backup@example.com:/remote/archive.tar.gz"* ]][m
 }[m
 [m
 @test "sftp upload writes batch file" {[m
[36m@@ -146,7 +159,7 @@[m [mteardown() {[m
 [m
     run "$SCRIPT_PATH" \[m
         --upload "sftp://backup@example.com:/remote/archive.tar.gz" \[m
[31m-        --out-dir "$OUT_DIR" \[m
[32m+[m[32m        --output "$OUT_DIR" \[m
         --export=local[m
 [m
     [ "$status" -eq 0 ][m
[36m@@ -169,7 +182,7 @@[m [mteardown() {[m
 [m
     run "$SCRIPT_PATH" \[m
         --upload "scp://backup@example.com:/remote/archive.tar.gz" \[m
[31m-        --out-dir "$OUT_DIR" \[m
[32m+[m[32m        --output "$OUT_DIR" \[m
         --retry 2 \[m
         --export=local[m
 [m
[36m@@ -188,7 +201,7 @@[m [mteardown() {[m
 [m
     run "$SCRIPT_PATH" \[m
         --upload "scp://backup@example.com:/remote/archive.tar.gz" \[m
[31m-        --out-dir "$OUT_DIR" \[m
[32m+[m[32m        --output "$OUT_DIR" \[m
         --retry 2 \[m
         --export=local[m
 [m
[36m@@ -203,40 +216,19 @@[m [mteardown() {[m
 [m
     run "$SCRIPT_PATH" \[m
         --upload "scp://backup@example.com:/remote/archive.tar.gz" \[m
[31m-        --out-dir "$OUT_DIR" \[m
[32m+[m[32m        --output "$OUT_DIR" \[m
         --export=scp \[m
         --dry-run[m
 [m
     [ "$status" -eq 0 ][m
     [ ! -f "$EXPECTED_ARCHIVE" ][m
[32m+[m[32m    [ ! -d "$OUT_DIR" ][m
     if [ -e "$MOCK_UPLOAD_LOG" ]; then[m
         [ ! -s "$MOCK_UPLOAD_LOG" ][m
     fi[m
 [m
     [[ "$output" == *"Ð ÐµÐ¶Ð¸Ð¼ dry-run: Ð³Ð¾Ñ‚Ð¾Ð²Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° SCP"* ]][m
     [[ "$output" == *"/remote/archive.tar.gz"* ]][m
[31m-=======[m
[31m-    MOCK_BIN="$BATS_TEST_TMPDIR/bin"[m
[31m-    mkdir -p "$MOCK_BIN"[m
[31m-[m
[31m-    cat >"$MOCK_BIN/tar" <<EOF[m
[31m-#!/bin/sh[m
[31m-touch "$BATS_TEST_TMPDIR/tar-invoked"[m
[31m-printf 'mock tar executed\n' >&2[m
[31m-exit 1[m
[31m-EOF[m
[31m-    chmod +x "$MOCK_BIN/tar"[m
[31m-[m
[31m-    PATH_ORIGINAL=$PATH[m
[31m-    PATH="$MOCK_BIN:$PATH_ORIGINAL"[m
[31m-    export PATH[m
[31m-[m
[31m-    rm -f "$BATS_TEST_TMPDIR/tar-invoked"[m
[31m-}[m
[31m-[m
[31m-teardown() {[m
[31m-    PATH=$PATH_ORIGINAL[m
[31m-    export PATH[m
 }[m
 [m
 @test "usage mentions dry-run and output options" {[m
[36m@@ -247,35 +239,43 @@[m [mteardown() {[m
 }[m
 [m
 @test "dry-run flag avoids side effects" {[m
[31m-    rm -f "$BATS_TEST_TMPDIR/tar-invoked"[m
[31m-    output_dir="$BATS_TEST_TMPDIR/custom-output"[m
[31m-    run "$SCRIPT_PATH" -n --output "$output_dir"[m
[32m+[m[32m    mock_tar_setup[m
[32m+[m[32m    output_dir="$TEST_ROOT/custom-output"[m
[32m+[m[32m    PATH_WITH_MOCK="$MOCK_TAR_DIR:$PATH"[m
[32m+[m
[32m+[m[32m    run env PATH="$PATH_WITH_MOCK" "$SCRIPT_PATH" -n --output "$output_dir"[m
[32m+[m
     [ "$status" -eq 0 ][m
     [[ "$output" == *"Ð ÐµÐ¶Ð¸Ð¼ dry-run: Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð±ÐµÐ· Ð¿Ð¾Ð±Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð²"* ]][m
     [[ "$output" == *"Ð ÐµÐ¶Ð¸Ð¼ dry-run: Ð°Ñ€Ñ…Ð¸Ð² Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð»ÑÑ"* ]][m
     [[ "$output" == *"$output_dir"* ]][m
[31m-    [ ! -f "$BATS_TEST_TMPDIR/tar-invoked" ][m
[32m+[m[32m    [ ! -f "$MOCK_TAR_MARKER" ][m
     [ ! -d "$output_dir" ][m
 }[m
 [m
 @test "DRY_RUN environment variable enables dry-run" {[m
[31m-    rm -f "$BATS_TEST_TMPDIR/tar-invoked"[m
[31m-    output_dir="$BATS_TEST_TMPDIR/env-output"[m
[31m-    run env DRY_RUN=true "$SCRIPT_PATH" --output "$output_dir"[m
[32m+[m[32m    mock_tar_setup[m
[32m+[m[32m    output_dir="$TEST_ROOT/env-output"[m
[32m+[m[32m    PATH_WITH_MOCK="$MOCK_TAR_DIR:$PATH"[m
[32m+[m
[32m+[m[32m    run env DRY_RUN=true PATH="$PATH_WITH_MOCK" "$SCRIPT_PATH" --output "$output_dir"[m
[32m+[m
     [ "$status" -eq 0 ][m
     [[ "$output" == *"Ð ÐµÐ¶Ð¸Ð¼ dry-run: Ð°Ñ€Ñ…Ð¸Ð² Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð»ÑÑ"* ]][m
[31m-    [ ! -f "$BATS_TEST_TMPDIR/tar-invoked" ][m
[32m+[m[32m    [ ! -f "$MOCK_TAR_MARKER" ][m
     [ ! -d "$output_dir" ][m
 }[m
 [m
 @test "--output accepts relative paths" {[m
[31m-    rm -f "$BATS_TEST_TMPDIR/tar-invoked"[m
[32m+[m[32m    mock_tar_setup[m
[32m+[m[32m    PATH_WITH_MOCK="$MOCK_TAR_DIR:$PATH"[m
     rm -rf relative-dir[m
     expected="$(pwd)/relative-dir"[m
[31m-    run env DRY_RUN=1 "$SCRIPT_PATH" --output relative-dir[m
[32m+[m
[32m+[m[32m    run env DRY_RUN=1 PATH="$PATH_WITH_MOCK" "$SCRIPT_PATH" --output relative-dir[m
[32m+[m
     [ "$status" -eq 0 ][m
     [[ "$output" == *"$expected"* ]][m
[31m-    [ ! -f "$BATS_TEST_TMPDIR/tar-invoked" ][m
[32m+[m[32m    [ ! -f "$MOCK_TAR_MARKER" ][m
     [ ! -d "$expected" ][m
[31m->>>>>>> origin/feat-5-backup-dry-run-output-tests[m
 }[m
