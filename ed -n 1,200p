[1mdiff --git a/scripts/user_installed_packages b/scripts/user_installed_packages[m
[1mindex e8c1ca1..dffea0e 100755[m
[1m--- a/scripts/user_installed_packages[m
[1m+++ b/scripts/user_installed_packages[m
[36m@@ -3,10 +3,6 @@[m
 [m
 set -eu[m
 [m
[31m-if set -o pipefail 2>/dev/null; then[m
[31m-    :[m
[31m-fi[m
[31m-[m
 PROGRAM=$(basename "$0")[m
 SCRIPT_PATH=$0[m
 [m
[36m@@ -15,7 +11,7 @@[m [mcase "$SCRIPT_PATH" in[m
     SCRIPT_SOURCE=$(dirname "$SCRIPT_PATH")[m
     ;;[m
 *)[m
[31m-    LOOKUP=$(command -v -- "$SCRIPT_PATH" 2>/dev/null)[m
[32m+[m[32m    LOOKUP=$(command -v -- "$SCRIPT_PATH" 2>/dev/null || printf '')[m
     if [ -n "$LOOKUP" ]; then[m
         SCRIPT_SOURCE=$(dirname "$LOOKUP")[m
     else[m
[36m@@ -44,92 +40,322 @@[m [mif [ -z "$VERSION" ]; then[m
     VERSION=$VERSION_FALLBACK[m
 fi[m
 [m
[32m+[m[32mEX_OK=0[m
[32m+[m[32mEX_USAGE=64[m
[32m+[m[32mEX_UNAVAILABLE=69[m
[32m+[m[32mEX_SOFTWARE=70[m
[32m+[m
[32m+[m[32mDEFAULT_STATUS_FILE='/usr/lib/opkg/status'[m
[32m+[m[32mSTATUS_FILE=$DEFAULT_STATUS_FILE[m
[32m+[m[32mUSER_INSTALLED_FILE=''[m
[32m+[m[32mINCLUDE_AUTO_DEPS=0[m
[32m+[m[32mEXCLUDE_PATTERNS=''[m
[32m+[m
 show_version() {[m
     printf '%s version %s\n' "$PROGRAM" "$VERSION"[m
 }[m
 [m
[31m-timestamp() {[m
[31m-    date '+%Y-%m-%d %H:%M:%S'[m
[32m+[m[32musage() {[m
[32m+[m[32m    cat <<EOF[m
[32m+[m[32m–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $PROGRAM [–û–ü–¶–ò–ò][m
[32m+[m
[32m+[m[32m–û–ø—Ü–∏–∏:[m
[32m+[m[32m      --status-file PATH         –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π status-—Ñ–∞–π–ª opkg (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é $DEFAULT_STATUS_FILE)[m
[32m+[m[32m      --user-installed-file PATH –î–æ–±–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã –∏–∑ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–ø–æ –æ–¥–Ω–æ–º—É –∏–º–µ–Ω–∏ –Ω–∞ —Å—Ç—Ä–æ–∫—É)[m
[32m+[m[32m  -x, --exclude PATTERN          –ò—Å–∫–ª—é—á–∏—Ç—å –ø–∞–∫–µ—Ç—ã –ø–æ —à–∞–±–ª–æ–Ω—É (–æ–ø—Ü–∏—é –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑)[m
[32m+[m[32m      --include-auto-deps        –í–∫–ª—é—á–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å Auto-Installed: yes[m
[32m+[m[32m  -h, --help                     –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É –∏ –≤—ã–π—Ç–∏[m
[32m+[m[32m  -V, --version                  –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é –∏ –≤—ã–π—Ç–∏[m
[32m+[m[32mEOF[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mfatal() {[m
[32m+[m[32m    message=$1[m
[32m+[m[32m    code=${2:-$EX_SOFTWARE}[m
[32m+[m[32m    printf '%s: %s\n' "$PROGRAM" "$message" >&2[m
[32m+[m[32m    exit "$code"[m
 }[m
 [m
[31m-log_info() {[m
[31m-    if [ "$#" -gt 0 ]; then[m
[31m-        printf '%s INFO %s\n' "$(timestamp)" "$*" >&2[m
[32m+[m[32mappend_exclude_pattern() {[m
[32m+[m[32m    pattern=$1[m
[32m+[m[32m    if [ -z "$pattern" ]; then[m
[32m+[m[32m        return[m
[32m+[m[32m    fi[m
[32m+[m
[32m+[m[32m    if [ -z "$EXCLUDE_PATTERNS" ]; then[m
[32m+[m[32m        EXCLUDE_PATTERNS=$pattern[m
     else[m
[31m-        printf '%s INFO\n' "$(timestamp)" >&2[m
[32m+[m[32m        EXCLUDE_PATTERNS=$(printf '%s\n%s' "$EXCLUDE_PATTERNS" "$pattern")[m
     fi[m
 }[m
 [m
[31m-for arg in "$@"; do[m
[31m-    case "$arg" in[m
[31m-    -V | --version)[m
[31m-        show_version[m
[31m-        exit 0[m
[31m-        ;;[m
[31m-    esac[m
[31m-done[m
[32m+[m[32mshould_exclude() {[m
[32m+[m[32m    pkg=$1[m
[32m+[m[32m    if [ -z "$EXCLUDE_PATTERNS" ]; then[m
[32m+[m[32m        return 1[m
[32m+[m[32m    fi[m
 [m
[31m-log_info '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤—Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ opkg'[m
[32m+[m[32m    old_ifs=$IFS[m
[32m+[m[32m    IFS='[m
[32m+[m[32m'[m
[32m+[m[32m    for pattern in $EXCLUDE_PATTERNS; do[m
[32m+[m[32m        if [ -z "$pattern" ]; then[m
[32m+[m[32m            continue[m
[32m+[m[32m        fi[m
[32m+[m[32m        case "$pkg" in[m
[32m+[m[32m        $pattern)[m
[32m+[m[32m            IFS=$old_ifs[m
[32m+[m[32m            return 0[m
[32m+[m[32m            ;;[m
[32m+[m[32m        esac[m
[32m+[m[32m    done[m
[32m+[m[32m    IFS=$old_ifs[m
[32m+[m[32m    return 1[m
[32m+[m[32m}[m
 [m
[31m-printf '\n'[m
[31m-printf '===============================================\n'[m
[31m-printf 'opkg update\n'[m
[32m+[m[32mparse_args() {[m
[32m+[m[32m    while [ $# -gt 0 ]; do[m
[32m+[m[32m        case "$1" in[m
[32m+[m[32m        -h|--help)[m
[32m+[m[32m            usage[m
[32m+[m[32m            exit "$EX_OK"[m
[32m+[m[32m            ;;[m
[32m+[m[32m        -V|--version)[m
[32m+[m[32m            show_version[m
[32m+[m[32m            exit "$EX_OK"[m
[32m+[m[32m            ;;[m
[32m+[m[32m        --status-file)[m
[32m+[m[32m            if [ $# -lt 2 ]; then[m
[32m+[m[32m                fatal '–û–ø—Ü–∏—è --status-file —Ç—Ä–µ–±—É–µ—Ç —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å' "$EX_USAGE"[m
[32m+[m[32m            fi[m
[32m+[m[32m            STATUS_FILE=$2[m
[32m+[m[32m            shift[m
[32m+[m[32m            ;;[m
[32m+[m[32m        --status-file=*)[m
[32m+[m[32m            STATUS_FILE=${1#--status-file=}[m
[32m+[m[32m            ;;[m
[32m+[m[32m        --user-installed-file)[m
[32m+[m[32m            if [ $# -lt 2 ]; then[m
[32m+[m[32m                fatal '–û–ø—Ü–∏—è --user-installed-file —Ç—Ä–µ–±—É–µ—Ç —É–∫–∞–∑–∞—Ç—å –ø—É—Ç—å' "$EX_USAGE"[m
[32m+[m[32m            fi[m
[32m+[m[32m            USER_INSTALLED_FILE=$2[m
[32m+[m[32m            shift[m
[32m+[m[32m            ;;[m
[32m+[m[32m        --user-installed-file=*)[m
[32m+[m[32m            USER_INSTALLED_FILE=${1#--user-installed-file=}[m
[32m+[m[32m            ;;[m
[32m+[m[32m        -x)[m
[32m+[m[32m            if [ $# -lt 2 ]; then[m
[32m+[m[32m                fatal '–û–ø—Ü–∏—è -x —Ç—Ä–µ–±—É–µ—Ç —É–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω' "$EX_USAGE"[m
[32m+[m[32m            fi[m
[32m+[m[32m            append_exclude_pattern "$2"[m
[32m+[m[32m            shift[m
[32m+[m[32m            ;;[m
[32m+[m[32m        --exclude)[m
[32m+[m[32m            if [ $# -lt 2 ]; then[m
[32m+[m[32m                fatal '–û–ø—Ü–∏—è --exclude —Ç—Ä–µ–±—É–µ—Ç —É–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω' "$EX_USAGE"[m
[32m+[m[32m            fi[m
[32m+[m[32m            append_exclude_pattern "$2"[m
[32m+[m[32m            shift[m
[32m+[m[32m            ;;[m
[32m+[m[32m        --exclude=*)[m
[32m+[m[32m            append_exclude_pattern "${1#--exclude=}"[m
[32m+[m[32m            ;;[m
[32m+[m[32m        --include-auto-deps)[m
[32m+[m[32m            INCLUDE_AUTO_DEPS=1[m
[32m+[m[32m            ;;[m
[32m+[m[32m        --include-auto-deps=*)[m
[32m+[m[32m            value=${1#--include-auto-deps=}[m
[32m+[m[32m            case "$value" in[m
[32m+[m[32m            ''|0|false|no|off)[m
[32m+[m[32m                INCLUDE_AUTO_DEPS=0[m
[32m+[m[32m                ;;[m
[32m+[m[32m            *)[m
[32m+[m[32m                INCLUDE_AUTO_DEPS=1[m
[32m+[m[32m                ;;[m
[32m+[m[32m            esac[m
[32m+[m[32m            ;;[m
[32m+[m[32m        *)[m
[32m+[m[32m            fatal "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è: $1" "$EX_USAGE"[m
[32m+[m[32m            ;;[m
[32m+[m[32m        esac[m
[32m+[m[32m        shift[m
[32m+[m[32m    done[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mparse_args "$@"[m
[32m+[m
[32m+[m[32mif [ -z "$STATUS_FILE" ]; then[m
[32m+[m[32m    fatal '–ü—É—Ç—å –∫ status-—Ñ–∞–π–ª—É –Ω–µ —É–∫–∞–∑–∞–Ω' "$EX_USAGE"[m
[32m+[m[32mfi[m
[32m+[m
[32m+[m[32mif [ ! -r "$STATUS_FILE" ]; then[m
[32m+[m[32m    fatal "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å status-—Ñ–∞–π–ª: $STATUS_FILE" "$EX_UNAVAILABLE"[m
[32m+[m[32mfi[m
 [m
[31m-# –ü–æ–ª—É—á–∞–µ–º —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏[m
[31m-DISTRI_TIME=$(awk '/Installed-Time/ {print $2}' /usr/lib/opkg/status | sort -n | head -n 1)[m
[31m-[m
[31m-# –ì–µ